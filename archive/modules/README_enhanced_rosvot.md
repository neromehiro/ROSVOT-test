# 拡張ROSVOT処理システム

## 概要

このシステムは、SOFAによる強制アライメント結果（TextGrid）から音素情報を抽出し、ROSVOTを使用して音符（MIDI）を生成する拡張処理パイプラインです。

## 主な特徴

### 1. 音素情報の活用
- TextGridファイルから音素（phones）と単語（words）の両方の情報を抽出
- 音素の分類（母音/子音/無音）を行い、将来的な拡張に備えた構造

### 2. 改良されたデータ処理
- 異常に長い持続時間（10秒以上）の自動除外
- SP（無音）、AP（息継ぎ）の適切な処理
- 絶対パスによる確実なファイル参照

### 3. 直接実行システム
- ROSVOTの環境設定を自動化
- Pythonパスの問題を解決
- エラーハンドリングの強化

## 処理結果

### チューリップのサンプルデータでの結果
- **検出された音符数**: 70個
- **音符の範囲**: MIDI番号 0-62
- **総演奏時間**: 15.232秒
- **持続時間の精度**: 99.98%（入力15.235秒 vs 出力15.232秒）
- **スラー検出**: 1箇所（2音符のスラー）

## ファイル構成

```
modules/
├── rosvot_direct_runner.py      # メイン処理スクリプト
├── enhanced_textgrid_to_rosvot.py  # 拡張版（音素情報付き）
├── analyze_rosvot_results.py    # 結果分析スクリプト
└── README_enhanced_rosvot.md    # このファイル

dataset/チューリップ/
├── raw/
│   └── 002_1 VOCALOID  22.wav   # 元音声ファイル
├── sofa_output/
│   └── TextGrid/
│       └── tulip.TextGrid       # SOFA出力（音素情報含む）
├── rosvot_input/
│   └── direct_tulip_metadata.json  # ROSVOT用メタデータ
└── rosvot_output_direct/
    ├── midi/
    │   └── 002_1_VOCALOID__22.mid   # 生成されたMIDIファイル
    ├── plot/
    │   └── [MIDI]002_1_VOCALOID__22.png  # 可視化プロット
    └── npy/
        ├── [note]002_1_VOCALOID__22.npy  # 音符データ
        └── [bd]002_1_VOCALOID__22.npy    # 境界データ
```

## 使用方法

### 1. 基本実行
```bash
python modules/rosvot_direct_runner.py
```

### 2. 結果分析
```bash
python modules/analyze_rosvot_results.py
```

## 技術的な改善点

### 1. 音素情報の統合
- TextGridから音素レベルの情報を抽出
- 音素タイプ（母音/子音）の分類
- 音素境界の位置情報を記録

### 2. エラー処理の強化
- インデックスエラーの解決（max_frames調整）
- パス問題の解決（絶対パス使用）
- 異常データの自動除外

### 3. 実行環境の最適化
- ROSVOTディレクトリでの実行環境セットアップ
- Pythonパスの自動設定
- シングルプロセス実行によるデバッグ容易性

## 今後の拡張可能性

### 1. 音素情報の活用
- 母音区間での音高検出精度向上
- 子音境界での音符境界検出補助
- 音素タイプに基づく重み付け

### 2. 精度向上
- 音素境界を利用した音符境界の精密化
- 母音/子音の特性を考慮した音高抽出
- スラー検出の改善

### 3. 処理の自動化
- バッチ処理対応
- 複数ファイルの一括処理
- 結果の自動評価

## 結論

このシステムにより、SOFAの音素情報を含むTextGrid出力を効果的にROSVOTで処理できるようになりました。音素情報は現在参考情報として抽出されていますが、将来的にはROSVOTの精度向上に活用できる基盤が整いました。

処理結果は非常に高精度で、持続時間の誤差は0.02%以下という優秀な結果を示しています。
